id: 06_Developer_integration_tests
agent: Developer

objective:
  Create integration test infrastructure to run use case tests against real containerized services via Docker Compose.

note: |
  This activity depends on:
  - Activity 04 (use case tests with mock harness)
  - Activity 05 (service implementations)

  Activity 04 created use case tests against ITestHarness interface.
  This activity creates RealServiceHarness to run those same tests against deployed services.

  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.
  This is the last activity in the pipeline — update design-changes/changelog.yml to mark the change as completed.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/services.yml
    description: "Service registry — discover service names, APIs, events, and dependencies"
  - input: use_case_tests/harnesses/base_harness.py
    description: "ITestHarness interface from activity 04"
  - input: use_case_tests/test_use_case_*.py
    description: "Use case tests from activity 04"
  - input: services/<service-name>/
    description: "Service implementations and Dockerfiles from activity 05"
  - input: architecture/contracts/*.py
    description: "Service contracts for request/response DTOs"
  - input: .ai/technical/06_integration_test_infrastructure.md
    description: "RealServiceHarness, Docker Compose, conftest fixtures, and troubleshooting patterns"
  - input: .ai/technical/05_service_production_readiness.md
    description: "Health endpoint requirements"
  - input: .ai/technical/09_architecture_contract_synchronization.md
    description: "Docker build context pattern"
  - input: design-changes/changelog.yml
    description: "Changelog to update on completion"

# --- Artifacts generated by the activity ---
outputs:
  - output: use_case_tests/harnesses/real_service_harness.py
    description: "ITestHarness implementation using HTTP requests to real services"
  - output: use_case_tests/conftest.py
    description: "Updated with docker_compose_services and integration_test_harness fixtures (keep existing test_harness)"
  - output: use_case_tests/docker-compose.test.yml
  - output: use_case_tests/build_test_images.sh
  - output: use_case_tests/run_integration_tests.sh
  - output: use_case_tests/pytest.ini
  - output: use_case_tests/README.md
  - output: architecture/_brief/{change_ref}/brief_integration_tests.md
    template: .ai/templates/template_brief.md
  - output: design-changes/changelog.yml
    description: "Updated: change status set to completed, all activities marked as completed"

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing integration test infrastructure before modifying it.

  1. **Pre-flight Validation**: Build Docker images and verify all services start successfully.
     Add /health endpoints to any service missing one (see .ai/technical/05_service_production_readiness.md).
     Do NOT proceed until all services start in Docker.

  2. **Create Integration Infrastructure**: Following .ai/technical/06_integration_test_infrastructure.md:
     - Create RealServiceHarness implementing ITestHarness via HTTP
     - Create docker-compose.test.yml with service and infrastructure containers
     - Update conftest.py with Docker Compose and integration harness fixtures
     - Create build script, test runner script, and pytest.ini

  3. **Create Documentation**: Generate README.md explaining mock vs integration test modes and how to run each

  4. **Validate**: Build images, run pytest with --integration flag, verify all tests pass and teardown completes cleanly

  5. **Update Changelog**: Set the change status to completed in design-changes/changelog.yml
     and mark all pipeline activities as completed.

  6. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_integration_tests.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "All services start successfully in Docker (pre-flight validation)"
  - criteria: "use_case_tests/harnesses/real_service_harness.py exists and implements ITestHarness"
  - criteria: "use_case_tests/docker-compose.test.yml exists with services, health checks, and port mappings"
  - criteria: "use_case_tests/conftest.py contains both test_harness (mock) and integration_test_harness (real) fixtures"
  - criteria: "use_case_tests/build_test_images.sh and run_integration_tests.sh exist and are executable"
  - criteria: "use_case_tests/pytest.ini exists with integration marker"
  - criteria: "use_case_tests/README.md documents both test modes"
  - criteria: "All use case tests pass when run with --integration flag"
  - criteria: "architecture/_brief/{change_ref}/brief_integration_tests.md exists"
  - criteria: "design-changes/changelog.yml updated with change status: completed"
