id: 02_Architect_service_decomposition
agent: Architect

objective:
  Decompose the product into services and define integration workflows, then create a work order for the Product Owner.

note: |
  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/_brief/{change_ref}/brief_product_definition.md
    description: "Product definition and use cases from Product Owner"
  - input: .ai/technical/01_architecture_technical_stack.md
    description: "Technical stack constraints and choices"
  - input: .ai/technical/02_architecture_hexagonal.md
    description: "Architectural patterns and principles"

# --- Artifacts generated by the activity ---
outputs:
  - output: architecture/services.yml
    template: .ai/templates/template_services.yml
  - output: architecture/workflows/workflow_<use-case-id>_<use-case-name>.md
    template: .ai/templates/template_integration_workflow.md
  - output: architecture/_brief/{change_ref}/brief_service_decomposition.md
    template: .ai/templates/template_brief.md

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing services.yml and workflows before modifying them.

  1. **Read**: Review product definition brief and all referenced use cases

  2. **Analyze**: Identify service candidates based on bounded contexts and responsibilities

  3. **REVIEW GATE 1 - Service Decomposition**:
     - Present proposed services with their responsibilities and owned entities
     - Use AskUserQuestion with options to Approve (generate as-is), Merge services (too granular), Split services (too monolithic), or Rename for clarity
     - Adjust service decomposition based on user selection

  4. **Create Services**: Define approved services and owned entities in architecture/services.yml using template

  5. **Create Workflows**: Generate one workflow file per use case in architecture/workflows/ using template

  6. **REVIEW GATE 2 - Communication Patterns**:
     - For each workflow, show the proposed communication pattern (synchronous HTTP, asynchronous events, or hybrid)
     - Use AskUserQuestion to validate patterns are appropriate for each workflow
     - Adjust if user requests different patterns

  7. **Verify Consistency**: Check that all services in workflows exist in services.yml

  8. **Verify Coverage**: Check that each use case has a corresponding workflow

  9. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_service_decomposition.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "architecture/services.yml exists"
  - criteria: "One workflow file exists in architecture/workflows/ for each use case in product/use_cases/"
  - criteria: "architecture/_brief/{change_ref}/brief_service_decomposition.md exists"
