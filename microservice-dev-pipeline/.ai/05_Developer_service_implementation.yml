id: 05_Developer_service_implementation
agent: Developer

objective:
  Implement or update a service following hexagonal architecture, satisfying its contracts and requirements.

note: |
  This activity implements a single service.
  It depends on outputs from activities 03a (requirements), 03b (contracts), and 04 (tests).
  The service must inherit from and implement the ABC interface defined in architecture/contracts/.

  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/contracts/<service-name>_service.py
    description: "Service ABC interface, DTOs, and event routing declarations"
  - input: architecture/contracts/common.py
    description: "Shared events and data types"
  - input: architecture/workflows/workflow_<use-case-id>_<use-case-name>.md
    description: "Service interaction patterns showing how this service participates"
  - input: product/<service-name>_service/REQ_<requirement_id>_<requirement_name>.md
    description: "Detailed technical requirements for this service"
  - input: use_case_tests/test_use_case_<use-case-id>_<use-case-name>.py
    description: "End-to-end tests that must pass with real service"
  - input: use_case_tests/harnesses/mock_<service-name>_service.py
    description: "Mock implementation as reference for expected behavior"
  - input: .ai/technical/01_architecture_technical_stack.md
    description: "Technology stack"
  - input: .ai/technical/02_architecture_hexagonal.md
    description: "Hexagonal architecture patterns, service structure, ABC inheritance pattern"
  - input: .ai/technical/05_service_production_readiness.md
    description: "Production readiness requirements"
  - input: .ai/technical/12_repository_integration_testing.md
    description: "Repository integration testing with NEW session verification pattern"
  - input: .ai/technical/09_architecture_contract_synchronization.md
    description: "Dockerfile build context pattern"
  - input: services/<service-name>/
    optional: true
    description: "Existing service implementation (if updating rather than creating)"

# --- Artifacts generated by the activity ---
outputs:
  - output: services/<service-name>/
    description: "Complete service following structure defined in .ai/technical/02_architecture_hexagonal.md (Section 8)"
  - output: services/<service-name>/tests/unit/
    description: "Unit tests including app startup test"
  - output: services/<service-name>/tests/integration/
    description: "Repository integration tests following .ai/technical/12_repository_integration_testing.md"
  - output: services/<service-name>/pyproject.toml
  - output: services/<service-name>/Dockerfile
  - output: services/<service-name>/README.md
  - output: architecture/_brief/{change_ref}/brief_service_implementation.md
    template: .ai/templates/template_brief.md

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing service code before modifying it.

  1. **Read**: Review contracts (ABC interface, DTOs, event routing), requirements, workflows, and mock implementation

  2. **Implement Service**: Following .ai/technical/02_architecture_hexagonal.md:
     - Create service structure (Section 8)
     - Define ports, implement adapters (production + in-memory), domain models, and business logic services
     - Service class must inherit from the ABC interface (Section 0)
     - Implement API layer and event publishing/consuming
     - Wire dependency injection and configuration
     - Follow .ai/technical/05_service_production_readiness.md for all production concerns

  3. **Write Unit Tests**: Test business logic with in-memory adapters, include app startup test

  4. **Write Repository Integration Tests**: Following .ai/technical/12_repository_integration_testing.md:
     - Use testcontainers for PostgreSQL
     - Use the "NEW session verification" pattern for all write operations
     - Include event handler persistence tests if service consumes events
     - Template: .ai/templates/template_repository_integration_test.py

  5. **Create Dockerfile and pyproject.toml**:
     - Follow .ai/technical/09_architecture_contract_synchronization.md for build context pattern

  6. **Validate**: Verify app imports, run unit tests and integration tests, confirm all pass

  7. **Document**: Create README.md with service purpose, how to run, environment variables, API endpoints

  8. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_service_implementation.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "services/<service-name>/ directory exists with hexagonal structure"
  - criteria: "Service class inherits from and implements ABC interface from architecture/contracts/"
  - criteria: "Events published/consumed as specified in contract event routing declarations"
  - criteria: "Production and in-memory adapters exist for each port"
  - criteria: "Unit tests exist and pass (including app startup test)"
  - criteria: "Repository integration tests exist, use testcontainers, and use NEW session verification pattern"
  - criteria: "If service consumes events: event handler persistence test exists"
  - criteria: "All tests pass: pytest tests/ -v"
  - criteria: "Dockerfile builds successfully"
  - criteria: "pyproject.toml and README.md exist"
  - criteria: "architecture/_brief/{change_ref}/brief_service_implementation.md exists"
