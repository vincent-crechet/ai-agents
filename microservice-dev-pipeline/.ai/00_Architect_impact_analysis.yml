id: 00_Architect_impact_analysis
agent: Architect

objective:
  Given a design change file, identify affected artifacts, determine the change type, and produce a brief defining the required pipeline.

note: |
  This is the entry point for all non-greenfield changes.
  For new products (greenfield / type: new_product), skip this activity and start directly at activity 01.
  This activity ensures requirements are assessed before any code changes are made.

  The change_ref is derived from the design-changes file name (without extension).
  Example: design-changes/02-add-observability.txt â†’ change_ref = "02-add-observability"
  All briefs for this change are written under architecture/_brief/{change_ref}/.

# --- Inputs required to start the activity ---
inputs:
  - input: design-changes/{change_ref}.txt
    description: "The design change file describing what needs to change and why"
  - input: .ai/change_types.yml
    description: "Change type definitions with required pipelines"
  - input: design-changes/changelog.yml
    description: "History of processed changes"
  - input: product/product_definition.md
    description: "Current product definition"
  - input: product/use_cases/
    description: "Current use cases"
  - input: product/
    description: "Current service requirements"
  - input: architecture/services.yml
    description: "Current service inventory"
  - input: architecture/contracts/
    description: "Current service contracts"
  - input: architecture/workflows/
    description: "Current integration workflows"

# --- Artifacts generated by the activity ---
outputs:
  - output: architecture/_brief/{change_ref}/brief_impact_analysis.md
    template: .ai/templates/template_brief.md
  - output: design-changes/changelog.yml
    description: "Updated with new change entry (status: in_progress)"

# --- Step-by-step procedure for the agent ---
instructions:
  1. **Read Design Change**: Parse the design-changes file to understand what needs to change and why.
     Extract the change_ref from the file name (e.g., "02-add-observability" from "02-add-observability.txt").

  2. **Classify Change Type**: Match the change to a type in .ai/change_types.yml.
     If the file includes a `type` hint in its YAML front matter, use it as a starting point but verify independently.

  3. **Assess Impact**: For each artifact category (use cases, requirements, contracts, workflows, tests, services):
     - Determine if the change affects it
     - Document which specific files are affected and why
     - Document which files were reviewed but are NOT affected

  4. **REVIEW GATE - Impact Scope**:
     - Present the classified change type, affected artifacts, and required pipeline to the user
     - Use AskUserQuestion to confirm scope is correct
     - Adjust if user identifies additional or fewer impacted artifacts

  5. **Update Changelog**: Add a new entry to design-changes/changelog.yml with status: in_progress,
     the determined change type, and the required pipeline.

  6. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_impact_analysis.md using template, including:
     - The design change file path and its content summary
     - The change type and required pipeline (from change_types.yml)
     - List of affected artifacts with expected changes
     - List of reviewed-but-unaffected artifacts

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "architecture/_brief/{change_ref}/brief_impact_analysis.md exists"
  - criteria: "Brief identifies the change type and required pipeline"
  - criteria: "Brief lists all affected artifacts"
  - criteria: "Brief lists all reviewed-but-unaffected artifacts"
  - criteria: "design-changes/changelog.yml updated with new change entry"
