id: 03a_PO_service_requirements
agent: ProductOwner

objective:
  Define detailed technical requirements for each service for Developer implementation.

note: |
  This activity runs IN PARALLEL with activity 03b (service interface definition).
  Both activities depend only on activity 02 outputs (workflows and services.yml).
  Activity 03a focuses on glass-box implementation requirements (database schemas, error codes, performance targets).
  Activity 03b focuses on interface contracts (DTOs, events, API contracts).

  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/_brief/{change_ref}/brief_service_decomposition.md
    description: "Service decomposition and workflows from Architect"

# --- Artifacts generated by the activity ---
outputs:
  - output: product/<service-name>_service/REQ_<requirement_id>_<requirement_name>.md
    template: .ai/templates/template_service_requirement.md
  - output: architecture/_brief/{change_ref}/brief_service_requirements.md
    template: .ai/templates/template_brief.md

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing requirement files before modifying them.

  1. **Read**: Review service decomposition brief and all referenced documents
  2. **Create Requirements**: Generate requirement files for each service using template.
     Update Change History table in each artifact (new version row with trigger, description, downstream impact).
  3. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_service_requirements.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "At least one REQ_*.md file exists in product/<service-name>_service/ for each service in architecture/services.yml"
  - criteria: "architecture/_brief/{change_ref}/brief_service_requirements.md exists"
