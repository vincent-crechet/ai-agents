id: 03b_Architect_service_interface_definition
agent: Architect

objective:
  Generate Python contract files defining service interface ABCs, DTOs, events, and event routing based on workflows.

note: |
  This activity runs IN PARALLEL with activity 03a (service requirements).
  Both activities depend only on activity 02 outputs (workflows and services.yml).
  Activity 03b focuses on interface contracts derived from workflows (Data Contracts section).
  Service requirements (03a) are optional for validation if available, but not required.

  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/services.yml
    description: "Service inventory and boundaries"
  - input: architecture/workflows/workflow_<use-case-id>_<use-case-name>.md
    description: "Service interaction patterns with data contract specifications"
  - input: product/use_cases/use_case_<use-case-id>_<use-case-name>.md
    description: "User-level acceptance criteria for context"
  - input: .ai/technical/01_architecture_technical_stack.md
    description: "Technical stack (Python, Pydantic, etc.)"
  - input: .ai/technical/02_architecture_hexagonal.md
    description: "Architecture-level contract patterns (Section 0: Service Interface ABC Pattern)"

  # Optional (from parallel activity 03a)
  - input: product/<service-name>_service/REQ_<requirement_id>_<requirement_name>.md
    optional: true
    description: "If available, validate contracts align with requirements"

# --- Artifacts generated by the activity ---
outputs:
  - output: architecture/contracts/common.py
    description: "Shared event classes (Pydantic models) used across services"
  - output: architecture/contracts/<service-name>_service.py
    description: "Per-service file containing: Request/Response DTOs, Service Interface ABC, Event Routing Declarations (EVENTS_PUBLISHED, EVENTS_CONSUMED)"
  - output: architecture/_brief/{change_ref}/brief_service_interface_definition.md
    template: .ai/templates/template_brief.md

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing contract files before modifying them.

  1. **Read**: Review workflows and extract service interactions, data flows, and event patterns

  2. **Analyze Service Boundaries**: For each service, identify from workflow arrows:
     - API operations exposed, events published, events consumed

  3. **Create Contracts**: Generate common.py and per-service contract files
     - Follow the Service Interface ABC Pattern in .ai/technical/02_architecture_hexagonal.md (Section 0)
     - Each per-service file contains: DTOs, ABC interface, and event routing declarations

  4. **Verify Completeness**:
     - Every workflow interaction has a corresponding ABC method
     - All workflow events are defined in contracts
     - If 03a requirements are available, verify alignment

  5. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_service_interface_definition.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "architecture/contracts/common.py exists"
  - criteria: "One .py file exists in architecture/contracts/ for each service in architecture/services.yml"
  - criteria: "architecture/_brief/{change_ref}/brief_service_interface_definition.md exists"
