id: 01_PO_business_analysis
agent: ProductOwner

objective:
  Translate a design change into product definition and use cases, then create a work order for the Architect.

note: |
  The change_ref is derived from the design-changes file name (without extension).
  Example: design-changes/01-url-shortener.txt → change_ref = "01-url-shortener"
  All briefs for this change are written under architecture/_brief/{change_ref}/.

  For greenfield (new_product): this is the first activity — no impact analysis brief exists.
  For evolution: the impact analysis brief from activity 00 provides scope and context.

# --- Inputs required to start the activity ---
inputs:
  - input: design-changes/{change_ref}.txt
    description: "The design change file describing the business need or change request"
  - input: design-changes/changelog.yml
    description: "History of processed changes"
  - input: architecture/_brief/{change_ref}/brief_impact_analysis.md
    optional: true
    description: "Impact analysis from activity 00 (present for non-greenfield changes)"

# --- Artifacts generated by the activity ---
outputs:
  - output: product/product_definition.md
    template: .ai/templates/template_product_definition.md
  - output: product/use_cases/use_case_<use_case_id>_<use_case_name>.md
    template: .ai/templates/template_use_case.md
  - output: architecture/_brief/{change_ref}/brief_product_definition.md
    template: .ai/templates/template_brief.md
  - output: design-changes/changelog.yml
    description: "Updated: new entry with status in_progress (greenfield) or activity 01 marked as completed"

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the design-changes file to understand the business need.
     Extract the change_ref from the file name (e.g., "01-url-shortener" from "01-url-shortener.txt").
     If an impact analysis brief exists (architecture/_brief/{change_ref}/brief_impact_analysis.md),
     read it to understand the trigger, affected artifacts, and scope. In update mode, read existing artifacts before modifying them.
     If no impact analysis exists (greenfield), the design-changes file is the sole trigger.
     For greenfield, add a new entry to design-changes/changelog.yml with status: in_progress.

  1. **Read**: Parse the design change to understand needs and objectives

  2. **REVIEW GATE 1 - Use Case Identification**:
     - Analyze the design change and identify potential user journeys/use cases
     - Present identified use cases to the user with brief descriptions (1-2 sentences each)
     - Use AskUserQuestion tool with multiSelect=true to let user select which use cases to include
     - Allow user to indicate if additional use cases are needed

  3. **Create Product Definition**: Generate product/product_definition.md using template, including only approved use cases

  4. **REVIEW GATE 2 - Product Definition Key Elements**:
     - Draft the Product Vision and Product Goals sections
     - Present these key elements to the user
     - Use AskUserQuestion to confirm vision aligns with business needs, goals are appropriate, and scope is correct
     - Revise if user requests changes

  5. **Create Use Cases**: Generate use case files in product/use_cases/ using template (one per approved use case)

  6. **REVIEW GATE 3 - Acceptance Criteria Validation**:
     - For the first use case, show 2-3 sample acceptance criteria
     - Use AskUserQuestion to validate criteria maintain black-box perspective (user-observable only, no HTTP codes or technical details)
     - If validation fails, regenerate all use cases with corrected perspective

  7. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_product_definition.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "product/product_definition.md exists"
  - criteria: "At least one use case file exists in product/use_cases/"
  - criteria: "architecture/_brief/{change_ref}/brief_product_definition.md exists"
