id: 04_Architect_use_case_tests
agent: Architect

objective:
  Create executable end-to-end tests with mock harness to validate service contracts, then create a work order for Developers.

note: |
  This activity depends on activity 03b (service interface definition) completing.
  Service requirements from activity 03a are optional - tests validate contracts against use case acceptance criteria.

  The {change_ref} is inherited from the upstream brief and used to namespace all briefs for this change.

# --- Inputs required to start the activity ---
inputs:
  - input: architecture/contracts/common.py
    description: "Shared data types and events from activity 03b"
  - input: architecture/contracts/<service-name>_service.py
    description: "Service interfaces to be tested from activity 03b"
  - input: architecture/workflows/workflow_<use-case-id>_<use-case-name>.md
    description: "Expected interaction patterns"
  - input: product/use_cases/use_case_<use-case-id>_<use-case-name>.md
    description: "Acceptance criteria to validate"
  - input: .ai/technical/04_use_case_test_harness_pattern.md
    description: "Mock event bus, mock services, mock harness orchestrator patterns (with code examples)"

# --- Artifacts generated by the activity ---
outputs:
  - output: use_case_tests/harnesses/base_harness.py
    description: "ITestHarness Protocol â€” simplified async API for tests to call across services"
  - output: use_case_tests/harnesses/mock_event_bus.py
  - output: use_case_tests/harnesses/mock_<service-name>_service.py
  - output: use_case_tests/harnesses/mock_harness.py
  - output: use_case_tests/conftest.py
    description: "Provides test_harness fixture returning MockTestHarness"
  - output: use_case_tests/test_use_case_<use-case-id>_<use-case-name>.py
  - output: architecture/_brief/{change_ref}/brief_use_case_tests.md
    template: .ai/templates/template_brief.md

# --- Step-by-step procedure for the agent ---
instructions:
  0. **Read Trigger and Upstream Context**: Read the upstream brief to understand the trigger and what changed.
     In update mode, read existing test and harness files before modifying them.

  1. **Read**: Review service contracts (ABC interfaces, DTOs, event routing) and workflows

  2. **Create Harness Interface and Mock Infrastructure**: Following .ai/technical/04_use_case_test_harness_pattern.md, generate:
     - Mock event bus, mock service implementations (one per service), and mock harness orchestrator
     - Method signatures must match the ABC interfaces exactly (async, return types)

  4. **Create Pytest Configuration**: Generate conftest.py with test_harness fixture returning MockTestHarness

  5. **Create Test Cases**: Generate one test file per use case:
     - Tests written against ITestHarness (not specific to mock implementation)
     - Validate acceptance criteria from use case files
     - Include tests for event publishing/consuming behavior

  6. **Validate**: Run pytest and verify all tests pass

  7. **Create Brief**: Generate architecture/_brief/{change_ref}/brief_use_case_tests.md using template.
     Include Change Record section: trigger, artifacts created/modified, artifacts reviewed but not changed.

# --- Conditions that must be met for completion ---
completion_criteria:
  - criteria: "use_case_tests/harnesses/base_harness.py exists"
  - criteria: "use_case_tests/harnesses/mock_event_bus.py exists"
  - criteria: "One mock_<service-name>_service.py exists for each service in architecture/services.yml"
  - criteria: "use_case_tests/harnesses/mock_harness.py exists and composes all mock services"
  - criteria: "use_case_tests/conftest.py exists and provides test_harness fixture"
  - criteria: "One test_use_case_*.py file exists for each use case in product/use_cases/"
  - criteria: "All tests pass when run with pytest"
  - criteria: "architecture/_brief/{change_ref}/brief_use_case_tests.md exists"
